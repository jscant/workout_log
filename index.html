<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Weekly Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .dark .tab-active {
            color: #60a5fa;
        }
        [contenteditable]:focus, .plan-editor-modal input:focus, .start-date-input:focus {
            outline: 2px solid #3b82f6;
            border-radius: 4px;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        details > summary {
            cursor: pointer;
            list-style: none; /* Hide the default marker */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Hide the default marker in Chrome */
        }
        details[open] > summary {
            margin-bottom: 0.5rem;
        }
        .modal { display: none; }
        .graph-toggle-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .dark .graph-toggle-btn.active {
            background-color: #2563eb;
        }
        .start-date-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        .dark .start-date-input::-webkit-calendar-picker-indicator {
             filter: invert(1);
        }
        .plan-editor-modal .details-arrow { transition: transform 0.2s; }
        .plan-editor-modal details[open] > summary .details-arrow { transform: rotate(90deg); }

        /* --- Mobile Responsive Styles --- */
        @media (max-width: 768px) {
            /* Make the main table layout stack vertically */
            .responsive-table {
                border: none;
                width: 100%;
            }

            .responsive-table thead {
                display: none; /* Hide table headers on mobile */
            }

            .responsive-table, .responsive-table tbody, .responsive-table tr {
                display: block;
            }

            .responsive-table tr {
                border: 1px solid #e5e7eb; /* dark:border-gray-700 */
                border-radius: 0.75rem; /* rounded-lg */
                margin-bottom: 1rem;
                padding: 1rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                /* background-color removed to inherit from body and prevent flicker */
            }
            .dark .responsive-table tr {
                border-color: #374151; /* dark:border-gray-700 */
                 /* background-color removed */
            }

            .responsive-table td {
                display: grid;
                grid-template-columns: 1fr 1fr; /* Equal columns for label and value */
                align-items: center;
                gap: 1rem;
                padding: 0.75rem 0; /* Vertical padding, no horizontal */
                border-bottom: 1px solid #e5e7eb; /* A light separator */
            }

            .dark .responsive-table td {
                border-bottom-color: #374151; /* dark border for separator */
            }


            .responsive-table td:last-child {
                border-bottom: none;
            }

            /* Use a pseudo-element to create the label from the data-label attribute */
            .responsive-table td[data-label]::before {
                content: attr(data-label);
                font-weight: 500; /* medium */
                color: #6b7280; /* text-gray-500 */
                white-space: nowrap;
            }
            .dark .responsive-table td[data-label]::before {
                color: #f9fafb; /* text-gray-50 (white) for contrast */
            }
            
            /* Center all values/inputs within their grid cell */
            .responsive-table td > * {
                justify-self: center;
                text-align: center;
                width: 100%;
                max-width: 100px; /* Constrain the width for a neater look */
            }

            /* Style the editable fields to look like inputs */
            .responsive-table [contenteditable="true"] {
                padding: 0.25rem 0.5rem;
                border-radius: 0.375rem; /* rounded-md */
                background-color: #f3f4f6; /* bg-gray-100 */
                border: 1px solid #d1d5db; /* border-gray-300 */
                color: #111827; /* text-gray-900 */
            }
            .dark .responsive-table [contenteditable="true"] {
                background-color: #4b5563; /* bg-gray-600 */
                border-color: #6b7280; /* border-gray-500 */
                color: #f9fafb; /* text-gray-50 */
            }
            .responsive-table [contenteditable="true"]:focus {
                 box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
                 border-color: #3b82f6;
            }

            /* Style for the Total value */
            .responsive-table td[data-label="Total"] > div {
                font-weight: 700; /* bold */
                color: #2563eb; /* text-blue-600 */
            }
            .dark .responsive-table td[data-label="Total"] > div {
                color: #60a5fa; /* dark:text-blue-400 */
            }


            /* Special handling for the first cell (Exercise Name) to make it a header */
            .responsive-table td.exercise-name-cell {
                display: block;
                grid-template-columns: none;
                padding-bottom: 0.75rem;
                margin-bottom: 0.75rem;
                border-bottom: 2px solid #e5e7eb;
                font-size: 1.125rem; /* text-lg */
                font-weight: 600; /* semibold */
            }
            .dark .responsive-table td.exercise-name-cell {
                border-bottom-color: #4b5563;
            }

            /* The exercise name cell doesn't need a ::before label */
            .responsive-table td.exercise-name-cell::before {
                display: none;
            }

            /* Reset alignment and width for the exercise name content */
            .responsive-table td.exercise-name-cell > * {
                justify-self: start;
                text-align: left;
                max-width: none;
            }
            
            /* The N/A text for bodyweight exercises */
            .responsive-table td > span {
                font-style: italic;
                color: #9ca3af; /* text-gray-400 */
            }
             .dark .responsive-table td > span {
                color: #d1d5db; /* dark:text-gray-300 */
            }

            /* Make top-level controls stack */
            .top-controls-container {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            .top-controls-container nav {
                order: 2; /* Move tabs below stats on mobile */
                justify-content: center;
            }
            .stats-container {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
                order: 1; /* Move stats above tabs */
            }
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8" style="display: none;">
        <header class="mb-6 p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Your Weekly Workout Log</h1>
                    <p id="user-info" class="mt-2 text-gray-600 dark:text-gray-400">Track sets, reps, and weights over time.</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <button id="customize-plan-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Customize Plan</button>
                    <button id="show-graphs-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Graphs</button>
                    <button id="export-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Export</button>
                    <button id="import-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Import</button>
                    <input type="file" id="import-file-input" class="hidden" accept="application/json">
                    <button id="add-week-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">New Week</button>
                    <button id="logout-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Logout</button>
                </div>
            </div>
             <div id="status-indicator" class="mt-4 flex items-center text-blue-500" style="display: none;"></div>
        </header>

        <main id="weeks-container" class="space-y-6"></main>
         <footer class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
            <p>Your data is saved automatically.</p>
        </footer>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-8">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">Login</h2>
            <form id="auth-form">
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email address</label>
                        <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                        <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div id="auth-error" class="mt-4 text-sm text-red-600 dark:text-red-400 text-center"></div>
                <div class="mt-6">
                    <button type="submit" id="auth-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Login</button>
                </div>
            </form>
            <p class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                <a href="#" id="auth-toggle-link" class="font-medium text-blue-600 hover:text-blue-500">Don't have an account? Register</a>
            </p>
        </div>
    </div>
    
    <div id="plan-editor-modal" class="modal plan-editor-modal fixed inset-0 bg-gray-900 bg-opacity-75 z-50">
        <div class="absolute inset-0 overflow-y-auto">
            <div class="min-h-full flex items-center justify-center p-4">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl p-6 sm:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Customize Your Workout Plan</h2>
                        <button id="close-plan-editor-btn" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
                    </div>
                    <div id="plan-editor-content" class="space-y-4"></div>
                    <div class="mt-6 flex justify-between">
                         <button id="add-day-btn" class="px-4 py-2 border border-dashed border-gray-400 text-sm font-medium rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Add Workout Day</button>
                        <div>
                            <button id="cancel-plan-changes-btn" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Cancel</button>
                            <button id="save-plan-btn" class="ml-3 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Save Plan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="graph-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-50" style="display: none;">
        <div class="absolute inset-0 overflow-y-auto">
            <div class="min-h-full flex items-center justify-center p-4">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-6xl p-6 sm:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Your Progress</h2>
                        <button id="close-graphs-btn" class="p-2 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                             <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div id="charts-container" class="space-y-10">
                         <div class="flex justify-center flex-wrap gap-2 mb-6 border-b border-gray-200 dark:border-gray-700 pb-6">
                            <button data-category="daily-volume" class="graph-toggle-btn px-4 py-2 text-sm font-medium rounded-md border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Daily Volume</button>
                            <button data-category="individual-exercises" class="graph-toggle-btn px-4 py-2 text-sm font-medium rounded-md border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Individual Exercises</button>
                            <button data-category="other" class="graph-toggle-btn px-4 py-2 text-sm font-medium rounded-md border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Other</button>
                        </div>
                        <div id="daily-volume-charts-container" data-graph-category="daily-volume" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                        <div id="individual-exercises-charts-container" data-graph-category="individual-exercises" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                        <div id="other-charts-container" data-graph-category="other" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                         <div id="no-graphs-message" class="hidden text-center text-gray-500 py-10">No progress to show yet. Log data for at least two weeks to see a graph.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-50" style="display: none;">
        <div class="min-h-full flex items-center justify-center p-4 text-center">
             <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/50">
                    <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:mt-5">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Remove Week?</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Are you sure you want to remove this week's log? This action cannot be undone.</p>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                    <button type="button" id="confirm-delete-btn" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2">Remove</button>
                    <button type="button" id="cancel-delete-btn" class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 sm:col-start-1 sm:mt-0">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATA STRUCTURE & INITIAL STATE ---
        function getDefaultPlan() {
            return [
                { id: 'monday', dayName: 'Monday', workoutName: 'Chest & Triceps (Strength)', exercises: [
                    { name: 'Barbell Bench Press', sets: '4', reps: '5-8', rest: '90 sec', isSupersetStart: false },
                    { name: 'Incline Dumbbell Press', sets: '3', reps: '8-10', rest: '60 sec', isSupersetStart: false },
                    { name: 'Dumbbell Skull Crusher', sets: '3', reps: '10-12', rest: '60 sec', isSupersetStart: false },
                ]},
                { id: 'tuesday', dayName: 'Tuesday', workoutName: 'Shoulders', exercises: [
                    { name: 'Dumbbell Overhead Press', sets: '4', reps: '6-8', rest: '60-90 sec', isSupersetStart: false },
                    { name: 'Dumbbell Lateral Raise', sets: '4', reps: '10-15', rest: '45-60 sec', isSupersetStart: false },
                    { name: 'Bent-Over Dumbbell Reverse Fly', sets: '3', reps: '12-15', rest: '45 sec', isSupersetStart: false },
                ]},
                { id: 'wednesday', dayName: 'Wednesday', workoutName: 'Arms (Biceps & Triceps)', exercises: [
                    { name: 'Dumbbell Hammer Curl', sets: '3', reps: '8-12', rest: '0 sec', isSupersetStart: true },
                    { name: 'Lying EZ Bar Tricep Extension', sets: '3', reps: '8-12', rest: '90 sec', isSupersetStart: false },
                    { name: 'Dumbbell Incline Curl', sets: '3', reps: '10-12', rest: '0 sec', isSupersetStart: true },
                    { name: 'Bench Dips (Bodyweight)', sets: '3', reps: 'To Failure', rest: '60 sec', isSupersetStart: false },
                ]},
                { id: 'friday', dayName: 'Friday', workoutName: 'Chest & Biceps (Volume)', exercises: [
                    { name: 'Incline Dumbbell Press', sets: '4', reps: '10-15', rest: '60 sec', isSupersetStart: false },
                    { name: 'Flat Dumbbell Fly', sets: '3', reps: '12-15', rest: '45 sec', isSupersetStart: false },
                    { name: 'Push-Ups', sets: '2', reps: 'To Failure', rest: '60 sec', isSupersetStart: false },
                    { name: 'Standing EZ Bar Curl', sets: '3', reps: '10-15', rest: '60 sec', isSupersetStart: false },
                ]}
            ];
        }
        
        // --- FIREBASE & APP STATE ---
        const appId = 'default-advanced-tracker';
        let db, auth, userId, workoutLog = [], workoutPlan = [];
        let isInitialLoad = true, weekIndexToDelete = null, isLoginMode = true;
        let planUnsubscribe = () => {};
        let dataUnsubscribe = () => {};

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const appContainer = document.getElementById('app-container');
        const planEditorModal = document.getElementById('plan-editor-modal');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');

        // --- APP INITIALIZATION ---
        async function init() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBZV5ijalUaAm2k7d5EKsNZRiuCCl8m5iA",
                    authDomain: "my-workout-tracker-5895b.firebaseapp.com",
                    projectId: "my-workout-tracker-5895b",
                    storageBucket: "my-workout-tracker-5895b.appspot.com",
                    messagingSenderId: "530364798317",
                    appId: "1:530364798317:web:061138d34994b806d53664"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);

                // --- Event Listeners ---
                document.getElementById('customize-plan-btn').addEventListener('click', openPlanEditor);
                document.getElementById('close-plan-editor-btn').addEventListener('click', () => planEditorModal.style.display = 'none');
                document.getElementById('cancel-plan-changes-btn').addEventListener('click', () => planEditorModal.style.display = 'none');
                document.getElementById('add-day-btn').addEventListener('click', addDayToPlanEditor);
                document.getElementById('save-plan-btn').addEventListener('click', savePlanFromEditor);
                planEditorModal.addEventListener('click', handlePlanEditorClicks);

                document.getElementById('add-week-btn').addEventListener('click', addNewWeek);
                document.getElementById('show-graphs-btn').addEventListener('click', generateAndShowGraphs);
                document.getElementById('close-graphs-btn').addEventListener('click', () => document.getElementById('graph-modal').style.display = 'none');
                document.getElementById('export-btn').addEventListener('click', exportData);
                document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
                document.getElementById('import-file-input').addEventListener('change', importDataFromFile);
                document.getElementById('logout-btn').addEventListener('click', handleLogout);

                authForm.addEventListener('submit', handleAuthSubmit);
                authToggleLink.addEventListener('click', toggleAuthMode);
                
                document.getElementById('cancel-delete-btn').addEventListener('click', () => document.getElementById('confirm-modal').style.display = 'none');
                document.getElementById('confirm-delete-btn').addEventListener('click', executeDeleteWeek);

                const weeksContainer = document.getElementById('weeks-container');
                weeksContainer.addEventListener('keydown', handleKeyDown);
                weeksContainer.addEventListener('click', handleContainerClick);
                weeksContainer.addEventListener('focusout', handleFocusOut);

                document.querySelectorAll('.graph-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.graph-toggle-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('[data-graph-category]').forEach(c => c.classList.add('hidden'));
                        btn.classList.add('active');
                        const containerToShow = document.querySelector(`[data-graph-category="${btn.dataset.category}"]`);
                        if (containerToShow) containerToShow.classList.remove('hidden');
                    });
                });

                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                        userId = user.uid;
                        updateUIForAuthState(true, user.email);
                        listenForPlanData();
                        listenForData();
                    } else {
                        userId = null;
                        workoutLog = [];
                        workoutPlan = [];
                        if (planUnsubscribe) planUnsubscribe();
                        if (dataUnsubscribe) dataUnsubscribe();
                        renderAllWeeks();
                        updateUIForAuthState(false);
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showStatusMessage("Error: Could not connect to the database.", 'error');
            }
        }
        
        // --- AUTHENTICATION ---
        function updateUIForAuthState(isLoggedIn, email = '') {
            if (isLoggedIn) {
                appContainer.style.display = 'block';
                authModal.style.display = 'none';
                document.getElementById('user-info').textContent = `Logged in as: ${email}`;
            } else {
                appContainer.style.display = 'none';
                authModal.style.display = 'flex';
                authError.textContent = '';
            }
        }
        
        function handleAuthSubmit(e) {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            authError.textContent = '';

            if (isLoginMode) {
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        authError.textContent = "Error: " + error.code.replace('auth/', '').replace(/-/g, ' ');
                    });
            } else {
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        authError.textContent = "Error: " + error.code.replace('auth/', '').replace(/-/g, ' ');
                    });
            }
        }

        function handleLogout() {
            signOut(auth).catch(error => console.error("Logout failed:", error));
        }

        function toggleAuthMode(e) {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            authError.textContent = '';
            if (isLoginMode) {
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                authToggleLink.innerHTML = 'Don\'t have an account? Register';
            } else {
                authTitle.textContent = 'Register';
                authSubmitBtn.textContent = 'Register';
                authToggleLink.innerHTML = 'Already have an account? Login';
            }
        }
        
        // --- WORKOUT PLAN CUSTOMIZATION ---
        function listenForPlanData() {
            if (planUnsubscribe) planUnsubscribe();
            const planRef = doc(db, 'artifacts', appId, 'users', userId, 'workoutData', 'plan');
            planUnsubscribe = onSnapshot(planRef, (docSnap) => {
                if (docSnap.exists()) {
                    workoutPlan = docSnap.data().plan;
                } else {
                    createDefaultPlanForUser(planRef);
                }
            });
        }

        function createDefaultPlanForUser(planRef) {
            workoutPlan = getDefaultPlan();
            setDoc(planRef, { plan: workoutPlan }).catch(e => console.error("Couldn't create default plan", e));
        }

        function openPlanEditor() {
            const content = document.getElementById('plan-editor-content');
            content.innerHTML = '';
            // Create a deep copy of workoutPlan to avoid direct mutation
            const planToEdit = JSON.parse(JSON.stringify(workoutPlan)); 
            planToEdit.forEach((day, dayIndex) => {
                content.appendChild(createPlanDayElement(day, dayIndex));
            });
            planEditorModal.style.display = 'flex';
        }

        function createPlanDayElement(day, dayIndex) {
            const details = document.createElement('details');
            details.className = 'bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg';
            details.open = true; // Keep it open by default for easier editing
            details.dataset.dayIndex = dayIndex; // Use dataset for easier access

            // Generate HTML for day header and exercises
            details.innerHTML = `
                <summary class="flex justify-between items-center font-semibold cursor-pointer">
                    <div class="flex items-center gap-2 w-full">
                         <svg class="details-arrow w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        <input class="plan-day-name text-lg font-bold bg-transparent flex-1" value="${day.dayName || ''}" placeholder="Workout Day Name">
                        <input class="plan-workout-name font-normal text-gray-600 dark:text-gray-400 bg-transparent flex-1" value="${day.workoutName || ''}" placeholder="Workout Name">
                    </div>
                    <button class="remove-day-btn text-red-500 hover:text-red-700 text-2xl font-bold">&times;</button>
                </summary>
                <div class="mt-4 pl-6 space-y-3">
                    ${(day.exercises || []).map((ex, exIndex) => createPlanExerciseElement(ex, dayIndex, exIndex)).join('')}
                    <button class="add-exercise-btn mt-2 px-3 py-1 border border-dashed border-gray-300 dark:border-gray-600 rounded-md text-sm text-blue-500 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-700 transition-colors">+ Add Exercise</button>
                </div>
            `;
            return details;
        }

        function createPlanExerciseElement(ex, dayIndex, exIndex) {
            return `
                <div class="plan-exercise-item flex flex-wrap items-center gap-2 py-1" data-ex-index="${exIndex}">
                    <input class="flex-1 min-w-[120px] p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="name" value="${ex.name || ''}" placeholder="Exercise Name">
                    <input class="w-20 p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="sets" value="${ex.sets || ''}" placeholder="Sets">
                    <input class="w-20 p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="reps" value="${ex.reps || ''}" placeholder="Reps">
                    <input class="w-24 p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="rest" value="${ex.rest || ''}" placeholder="Rest">
                    <label class="flex items-center text-sm ml-auto sm:ml-0">
                        <input type="checkbox" data-field="isSupersetStart" ${ex.isSupersetStart ? 'checked' : ''} class="mr-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">Superset
                    </label>
                    <button class="remove-exercise-btn p-1 text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                </div>
            `;
        }

        // Handles clicks within the plan editor modal for adding/removing days and exercises.
        function handlePlanEditorClicks(e) {
            const dayElement = e.target.closest('details[data-day-index]');
            
            // Handle adding a new exercise
            if (e.target.matches('.add-exercise-btn')) {
                if (!dayElement) return; // Ensure we're within a day element
                const exerciseContainer = dayElement.querySelector('.space-y-3');
                // Create a new div element for the exercise
                const newExerciseEl = document.createElement('div');
                newExerciseEl.className = 'plan-exercise-item flex flex-wrap items-center gap-2 py-1'; // Add Tailwind classes
                // Populate its innerHTML with a blank exercise template
                newExerciseEl.innerHTML = `
                    <input class="flex-1 min-w-[120px] p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="name" value="" placeholder="Exercise Name">
                    <input class="w-20 p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="sets" value="" placeholder="Sets">
                    <input class="w-20 p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="reps" value="" placeholder="Reps">
                    <input class="w-24 p-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded" data-field="rest" value="" placeholder="Rest">
                    <label class="flex items-center text-sm ml-auto sm:ml-0">
                        <input type="checkbox" data-field="isSupersetStart" class="mr-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">Superset
                    </label>
                    <button class="remove-exercise-btn p-1 text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                `;
                // Insert the new exercise element before the "Add Exercise" button
                exerciseContainer.insertBefore(newExerciseEl, e.target);
            }
            // Handle removing a workout day
            if (e.target.matches('.remove-day-btn')) {
                if (dayElement) {
                    dayElement.remove();
                }
            }
            // Handle removing an individual exercise
            if (e.target.matches('.remove-exercise-btn')) {
                e.target.closest('.plan-exercise-item').remove();
            }
        }

        function addDayToPlanEditor() {
            const planContent = document.getElementById('plan-editor-content');
            const newDayIndex = planContent.children.length;
            const newDay = { dayName: `Day ${newDayIndex + 1}`, workoutName: 'New Workout', exercises: [] };
            planContent.appendChild(createPlanDayElement(newDay, newDayIndex));
        }

        function savePlanFromEditor() {
            const newPlan = [];
            document.querySelectorAll('#plan-editor-content details').forEach(dayEl => {
                const day = {
                    // Generate a simple ID from day name for internal use (e.g., tab IDs)
                    id: dayEl.querySelector('.plan-day-name').value.toLowerCase().replace(/\s+/g, '-'),
                    dayName: dayEl.querySelector('.plan-day-name').value,
                    workoutName: dayEl.querySelector('.plan-workout-name').value,
                    exercises: []
                };
                dayEl.querySelectorAll('.plan-exercise-item').forEach(exEl => {
                    const exercise = {
                        name: exEl.querySelector('[data-field="name"]').value,
                        sets: exEl.querySelector('[data-field="sets"]').value,
                        reps: exEl.querySelector('[data-field="reps"]').value,
                        rest: exEl.querySelector('[data-field="rest"]').value,
                        isSupersetStart: exEl.querySelector('[data-field="isSupersetStart"]').checked
                    };
                    day.exercises.push(exercise);
                });
                newPlan.push(day);
            });
            
            const planRef = doc(db, 'artifacts', appId, 'users', userId, 'workoutData', 'plan');
            setDoc(planRef, { plan: newPlan })
                .then(() => {
                    showStatusMessage('Plan saved successfully!', 'success');
                    planEditorModal.style.display = 'none';
                })
                .catch(e => showStatusMessage(`Error saving plan: ${e.message}`, 'error'));
        }

        function getWeekObjectFromPlan(weekNumber, startDate) {
            const planCopy = JSON.parse(JSON.stringify(workoutPlan)); // Deep copy the current plan
            return {
                weekNumber: weekNumber,
                startDate: startDate,
                bodyWeight: { monday: '', wednesday: '', friday: '' },
                days: planCopy.map(day => ({
                    ...day,
                    exercises: day.exercises.map(ex => ({
                        ...ex,
                        weight: '', // Initialize weight for new exercises
                        setsData: Array(parseInt(ex.sets, 10) || 0).fill({ reps: '' }) // Initialize setsData
                    }))
                }))
            };
        }

        // --- DATA HANDLING & RENDERING ---
        function listenForData() {
            if (dataUnsubscribe) dataUnsubscribe(); // Unsubscribe from previous listener if any
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'workoutData', 'mainLog');
            
            dataUnsubscribe = onSnapshot(docRef, (docSnap) => {
                // Prevent re-rendering on local writes to avoid flicker/disruption during input
                if (docSnap.metadata.hasPendingWrites && !isInitialLoad) {
                    console.log("Skipping render due to pending writes.");
                    return; 
                }
                
                workoutLog = (docSnap.exists() && docSnap.data().log) ? docSnap.data().log : [];
                renderAllWeeks();
                hideStatusMessage(); // Hide any loading message
                if (isInitialLoad) isInitialLoad = false; // Mark initial load complete
            }, (error) => {
                console.error("Error with onSnapshot:", error);
                showStatusMessage('Error loading data.', 'error');
            });
        }

        function renderAllWeeks() {
            const container = document.getElementById('weeks-container');
            container.innerHTML = ''; // Clear existing content

            if (workoutLog.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">No workouts logged yet.</h3>
                        <p class="mt-2 text-gray-500 dark:text-gray-400">Click "New Week" to get started!</p>
                    </div>
                `;
                return;
            }

            // Sort weeks by number (they are re-numbered on save)
            workoutLog.sort((a, b) => a.weekNumber - b.weekNumber);
            
            // Render weeks in reverse order to show latest week on top
            [...workoutLog].reverse().forEach((week) => {
                const originalIndex = workoutLog.findIndex(w => w.weekNumber === week.weekNumber); // Get the actual index in the sorted array
                const weekElement = createWeekElement(week, originalIndex);
                container.appendChild(weekElement);
            });
        }

        function createWeekElement(week, weekIndex) {
            const details = document.createElement('details');
            details.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden';
            details.open = weekIndex === workoutLog.length - 1; 

            const summary = document.createElement('summary');
            summary.className = 'flex justify-between items-center p-6 text-gray-900 dark:text-white cursor-pointer';

            summary.innerHTML = `
                <div class="flex items-center gap-4">
                    <svg class="w-6 h-6 text-blue-500 details-arrow transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                    <span class="text-xl font-bold">Week ${week.weekNumber}</span>
                    <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 font-medium">
                        Starts: 
                        <input 
                            type="text" 
                            value="${formatDateToDDMMYYYY(week.startDate)}" 
                            data-week-index="${weekIndex}" 
                            data-field="startDate"
                            placeholder="DD/MM/YYYY"
                            class="start-date-input bg-transparent p-1 rounded-md w-28 text-center hover:bg-gray-200 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <button data-week-index="${weekIndex}" class="remove-week-btn p-2 rounded-full text-gray-400 hover:bg-red-100 dark:hover:bg-red-900/50 hover:text-red-500 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                </button>
            `;
            
            const weekContent = document.createElement('div');
            weekContent.className = 'px-6 pb-6';

            const topControlsContainer = document.createElement('div');
            topControlsContainer.className = 'top-controls-container flex flex-wrap justify-between items-end border-b border-gray-200 dark:border-gray-700 mb-6';

            const tabsContainer = document.createElement('nav');
            tabsContainer.className = '-mb-px flex space-x-1 sm:space-x-4';
            
            (week.days || []).forEach((dayData, dayIndex) => {
                const tab = document.createElement('a');
                tab.href = '#';
                tab.dataset.weekIndex = weekIndex;
                tab.dataset.dayId = dayData.id;
                tab.className = `day-tab w-1/4 sm:w-auto capitalize border-b-2 font-medium px-1 py-4 text-center text-sm sm:text-base text-gray-500 dark:text-gray-400 hover:text-blue-500 hover:border-blue-500 dark:hover:text-blue-400 dark:hover:border-blue-400 transition-colors ${dayIndex === 0 ? 'tab-active' : ''}`;
                tab.textContent = dayData.dayName;
                tabsContainer.appendChild(tab);
            });

            const statsContainer = document.createElement('div');
            statsContainer.className = 'stats-container flex items-end gap-4 pb-3';

            const bodyWeightSection = document.createElement('div');
            bodyWeightSection.className = 'flex items-end gap-3';
            const bw = week.bodyWeight || { monday: '', wednesday: '', friday: '' };
            bodyWeightSection.innerHTML = `
                <div class="font-medium text-sm text-gray-700 dark:text-gray-300 self-center whitespace-nowrap">Weigh-in (kg):</div>
                <div class="flex flex-col items-center">
                    <label class="text-xs text-gray-500">Mon</label>
                    <div contenteditable="true" data-week-index="${weekIndex}" data-field="bodyWeight.monday" class="p-1 w-[60px] text-center font-semibold bg-gray-100 dark:bg-gray-700 border-b-2 border-gray-300 dark:border-gray-600 focus:border-blue-500 rounded-t-md">${bw.monday || ''}</div>
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-xs text-gray-500">Wed</label>
                    <div contenteditable="true" data-week-index="${weekIndex}" data-field="bodyWeight.wednesday" class="p-1 w-[60px] text-center font-semibold bg-gray-100 dark:bg-gray-700 border-b-2 border-gray-300 dark:border-gray-600 focus:border-blue-500 rounded-t-md">${bw.wednesday || ''}</div>
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-xs text-gray-500">Fri</label>
                    <div contenteditable="true" data-week-index="${weekIndex}" data-field="bodyWeight.friday" class="p-1 w-[60px] text-center font-semibold bg-gray-100 dark:bg-gray-700 border-b-2 border-gray-300 dark:border-gray-600 focus:border-blue-500 rounded-t-md">${bw.friday || ''}</div>
                </div>
            `;
            
            const meanWeightResult = calculateMeanWeight(week);
            const meanWeightSection = document.createElement('div');
            meanWeightSection.className = 'flex items-center gap-2';
            // ### FIX: Changed "Mean Weight" to "Mean Body Weight"
            meanWeightSection.innerHTML = `
                <span class="font-medium text-sm text-gray-700 dark:text-gray-300 whitespace-nowrap">Mean Body Weight:</span>
                <span id="week-mean-weight-${weekIndex}" class="font-semibold text-blue-600 dark:text-blue-400">${meanWeightResult.mean} kg</span>
            `;

            const weeklyVolume = calculateWeekVolume(week).toFixed(1);
            const weeklyVolumeSection = document.createElement('div');
            weeklyVolumeSection.className = 'flex items-center gap-2';
            weeklyVolumeSection.innerHTML = `
                <span class="font-medium text-sm text-gray-700 dark:text-gray-300 whitespace-nowrap">Weekly Volume:</span>
                <span id="week-volume-total-${weekIndex}" class="font-semibold text-blue-600 dark:text-blue-400">${weeklyVolume} kg</span>
            `;

            statsContainer.appendChild(bodyWeightSection);
            statsContainer.appendChild(meanWeightSection);
            statsContainer.appendChild(weeklyVolumeSection);

            topControlsContainer.appendChild(tabsContainer);
            topControlsContainer.appendChild(statsContainer);
            weekContent.appendChild(topControlsContainer);

            const contentContainer = document.createElement('div');
            
            (week.days || []).forEach((dayData, dayIndex) => {
                const panel = document.createElement('div');
                panel.id = `content-week-${weekIndex}-day-${dayData.id}`;
                panel.className = `day-panel ${dayIndex === 0 ? '' : 'hidden'}`;
                panel.innerHTML = getDayTableHTML(dayData, weekIndex, dayData.id);
                contentContainer.appendChild(panel);
            });

            weekContent.appendChild(contentContainer);
            details.appendChild(summary);
            details.appendChild(weekContent);
            return details;
        }
        
        function getDayTableHTML(dayData, weekIndex, dayId) {
             const maxSets = Math.max(0, ...(dayData.exercises || []).map(ex => parseInt(ex.sets)));
             const dayVolume = calculateDayVolume(dayData).toFixed(1);
             return `
                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">${dayData.workoutName}</h3>
                <div class="overflow-x-auto">
                    <table class="responsive-table min-w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="pl-4 pr-2 py-3 text-left font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Exercise</th>
                                <th class="px-2 py-3 text-center font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Weight (kg)</th>
                                ${Array.from({ length: maxSets }, (_, i) => `<th class="px-2 py-3 text-center font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Set ${i + 1}</th>`).join('')}
                                <th class="px-4 py-3 text-center font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="md:bg-white md:dark:bg-gray-800 md:divide-y md:divide-gray-200 md:dark:divide-gray-700">
                            ${(dayData.exercises || []).map((ex, exIndex) => {
                                const total = calculateTotal(ex);
                                const displayedTotal = (typeof total.value === 'number') ? total.value.toFixed(1) : total.value;
                                return `
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                    <td class="exercise-name-cell pl-4 pr-2 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">
                                        <div>${ex.name}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-x-3 mt-1 font-normal">
                                            <span>${ex.sets}x${ex.reps}</span>
                                            <span class="text-gray-300 dark:text-gray-600">|</span>
                                            <span>Rest: ${ex.rest}</span>
                                            ${ex.isSupersetStart ? '<span class="ml-1 px-2 py-0.5 text-xs font-semibold text-purple-800 bg-purple-100 dark:bg-purple-900 dark:text-purple-200 rounded-full">Superset</span>' : ''}
                                        </div>
                                    </td>
                                    <td data-label="Weight (kg)" class="px-2 py-4 text-center">
                                        ${isBodyweight(ex) ? 
                                            `<span class="text-gray-400 dark:text-gray-500">N/A</span>` : 
                                            `<div contenteditable="true" data-week-index="${weekIndex}" data-day-id="${dayData.id}" data-ex-index="${exIndex}" data-field="weight" class="p-1 min-w-[60px] text-center border-b dark:border-gray-600 focus:border-blue-500">${ex.weight || ''}</div>`
                                        }
                                    </td>
                                    ${Array.from({ length: maxSets }, (_, setIndex) => {
                                        const setTarget = parseInt(ex.sets, 10) || 0;
                                        if (setIndex < setTarget) {
                                            const setData = ex.setsData ? (ex.setsData[setIndex] || { reps: '' }) : { reps: '' };
                                            return `
                                                <td data-label="Set ${setIndex + 1}" class="px-2 py-4">
                                                     <div contenteditable="true" data-week-index="${weekIndex}" data-day-id="${dayData.id}" data-ex-index="${exIndex}" data-set-index="${setIndex}" data-field="reps" class="p-1 min-w-[40px] text-center border-b dark:border-gray-600 focus:border-blue-500">${setData.reps || ''}</div>
                                                </td>`;
                                        }
                                        return '<td class="px-2 py-4"></td>';
                                    }).join('')}
                                    <td data-label="Total" id="total-week-${weekIndex}-day-${dayId}-ex-${exIndex}" class="px-4 py-4 text-center font-semibold text-gray-800 dark:text-gray-200"><div>${displayedTotal} ${total.unit}</div></td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
                <div id="day-volume-total-week-${weekIndex}-day-${dayId}" class="text-right mt-4 pr-4 font-bold text-lg text-blue-600 dark:text-blue-400">
                    Total Day Volume: ${dayVolume} kg
                </div>
            `;
        }
        
        function calculateMeanWeight(week) {
            if (!week || typeof week.bodyWeight !== 'object' || week.bodyWeight === null) {
                return { mean: 'N/A', count: 0 };
            }
            const weights = [
                parseFloat(week.bodyWeight.monday),
                parseFloat(week.bodyWeight.wednesday),
                parseFloat(week.bodyWeight.friday)
            ].filter(w => !isNaN(w) && w > 0);

            if (weights.length === 0) {
                return { mean: 'N/A', count: 0 };
            }

            const sum = weights.reduce((acc, val) => acc + val, 0);
            const mean = sum / weights.length;
            return { mean: mean.toFixed(1), count: weights.length };
        }

        function calculateWeekVolume(week) {
            if (!week || !week.days) return 0;
            return week.days.reduce((total, day) => total + calculateDayVolume(day), 0);
        }

        function calculateDayVolume(day) {
            if(!day || !day.exercises) return 0;
            return day.exercises.reduce((total, ex) => {
                if (!isBodyweight(ex)) {
                    const totalEx = calculateTotal(ex);
                    return total + totalEx.value;
                }
                return total;
            }, 0);
        }

        function calculateTotal(exercise) {
            if(!exercise || !exercise.setsData) return { value: 0, unit: 'kg'};
            const totalReps = exercise.setsData.reduce((sum, set) => sum + (parseInt(set.reps, 10) || 0), 0);
            if (isBodyweight(exercise)) {
                return { value: totalReps, unit: 'reps' };
            }
            const weight = parseFloat(exercise.weight) || 0;
            const calculatedValue = weight * totalReps;
            return { value: calculatedValue, unit: 'kg' };
        }
        
        function isBodyweight(exercise) {
            const nameLower = (exercise.name || '').toLowerCase();
            return nameLower.includes('(bodyweight)') || nameLower.includes('push-ups') || nameLower.includes('dips');
        }
        
        // --- EVENT HANDLING ---
        function handleContainerClick(e) {
            const tabTarget = e.target.closest('.day-tab');
            const removeBtnTarget = e.target.closest('.remove-week-btn');

            if (tabTarget) {
                e.preventDefault();
                const weekContent = tabTarget.closest('.px-6.pb-6');
                if(!weekContent) return;
                
                weekContent.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('tab-active'));
                weekContent.querySelectorAll('.day-panel').forEach(panel => panel.classList.add('hidden'));

                tabTarget.classList.add('tab-active');
                const panelToShow = weekContent.querySelector(`#content-week-${tabTarget.dataset.weekIndex}-day-${tabTarget.dataset.dayId}`);
                if (panelToShow) panelToShow.classList.remove('hidden');

            } else if (removeBtnTarget) {
                e.preventDefault();
                promptDeleteWeek(parseInt(removeBtnTarget.dataset.weekIndex, 10));
            }
        }
        
       function handleKeyDown(e) {
            const target = e.target;
            if (e.key !== 'Tab' || !target.matches('[contenteditable="true"][data-week-index]')) return;
            
            e.preventDefault();
            
            const openWeekDetails = target.closest('details[open]');
            if (!openWeekDetails) return;
            
            const bodyWeightFields = openWeekDetails.querySelectorAll('[data-field^="bodyWeight."]');
            const activeDayPanel = openWeekDetails.querySelector(`.day-panel:not(.hidden)`);
            if (!activeDayPanel) return;

            const allFields = [...bodyWeightFields, ...activeDayPanel.querySelectorAll('[contenteditable="true"]')].filter(el => el);
            
            const currentIndex = allFields.indexOf(target);
            if (currentIndex === -1) return;
            
            let nextIndex = e.shiftKey ? currentIndex - 1 : currentIndex + 1;

            if (nextIndex >= 0 && nextIndex < allFields.length) {
                allFields[nextIndex].focus();
            }
        }

        function handleFocusOut(e) {
            const target = e.target;
            if (target.matches('[contenteditable="true"][data-week-index]') || target.matches('.start-date-input')) {
                updateCellAndDOM(target);
            }
        }
        
        function updateCellAndDOM(target) {
            if (!target || !target.dataset.weekIndex) return;

            const { weekIndex, dayId, exIndex, setIndex, field } = target.dataset;
            // ### FIX: Added .trim() to remove whitespace from input
            const value = ((target.tagName.toLowerCase() === 'input') ? target.value : target.textContent).trim();
            
            const originalWeekIndex = parseInt(weekIndex, 10);
            if (isNaN(originalWeekIndex) || originalWeekIndex >= workoutLog.length) return;
            
            let dataChanged = false;
            const week = workoutLog[originalWeekIndex];

            if (field === 'startDate') {
                const newYMDDate = parseDDMMYYYYtoYMD(value);
                if (newYMDDate && week.startDate !== newYMDDate) {
                    week.startDate = newYMDDate;
                    workoutLog.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    workoutLog.forEach((week, index) => { week.weekNumber = index + 1; });
                    isInitialLoad = true;
                    dataChanged = true;
                } else if (!newYMDDate && value !== '') {
                    target.value = formatDateToDDMMYYYY(week.startDate);
                }
            // ### FIX: Added robust handling for the bodyWeight object to prevent errors
            } else if (field && field.startsWith('bodyWeight.')) {
                // Defensive check to handle old data formats and initialize if needed
                if (typeof week.bodyWeight !== 'object' || week.bodyWeight === null) {
                    week.bodyWeight = { monday: '', wednesday: '', friday: '' };
                }
                const day = field.split('.')[1]; // 'monday', 'wednesday', or 'friday'
                if (week.bodyWeight[day] !== value) {
                    week.bodyWeight[day] = value;
                    dataChanged = true;
                    // Recalculate mean weight and update the DOM
                    const meanWeightResult = calculateMeanWeight(week);
                    const meanWeightCell = document.getElementById(`week-mean-weight-${originalWeekIndex}`);
                    if (meanWeightCell) {
                         meanWeightCell.textContent = `${meanWeightResult.mean} kg`;
                    }
                }
            } else {
                const dayObject = week.days.find(d => d.id === dayId);
                if (!dayObject || !dayObject.exercises) return;
                
                const currentExercise = dayObject.exercises[exIndex];
                if (!currentExercise) return;

                if (field === 'weight') {
                    if (currentExercise.weight !== value) {
                        currentExercise.weight = value;
                        dataChanged = true;
                    }
                } else if (field === 'reps') {
                     if (!currentExercise.setsData[setIndex]) currentExercise.setsData[setIndex] = {};
                     if (currentExercise.setsData[setIndex].reps !== value) {
                        currentExercise.setsData[setIndex].reps = value;
                        dataChanged = true;
                    }
                }
                
                if (dataChanged) {
                    const newTotal = calculateTotal(currentExercise);
                    const totalCell = target.closest('tr').querySelector(`[id^="total-week-"]`);
                    if (totalCell) {
                        const displayedTotal = (typeof newTotal.value === 'number') ? newTotal.value.toFixed(1) : newTotal.value;
                        totalCell.textContent = `${displayedTotal} ${newTotal.unit}`;
                    }
                    
                    const newDayVolume = calculateDayVolume(dayObject).toFixed(1);
                    const dayVolumeCell = target.closest('.day-panel').querySelector(`[id^="day-volume-total-"]`);
                    if (dayVolumeCell) dayVolumeCell.textContent = `Total Day Volume: ${newDayVolume} kg`;

                    const newWeekVolume = calculateWeekVolume(week).toFixed(1);
                    const weekVolumeCell = document.getElementById(`week-volume-total-${originalWeekIndex}`);
                    if (weekVolumeCell) {
                        weekVolumeCell.textContent = `${newWeekVolume} kg`;
                    }
                }
            }
            
            if (dataChanged) saveData();
        }
        
        function addNewWeek() {
            if (workoutPlan.length === 0) {
                showStatusMessage('Please set up a workout plan first!', 'error');
                return;
            }
            let nextWeekNumber = workoutLog.length > 0 ? workoutLog.length + 1 : 1;
            let nextStartDate;
            if (workoutLog.length > 0) {
                 const lastWeek = workoutLog.reduce((latest, week) => new Date(week.startDate) > new Date(latest.startDate) ? week : latest, workoutLog[0]);
                 let lastDate = new Date(lastWeek.startDate);
                 lastDate.setDate(lastDate.getDate() + 7);
                 nextStartDate = lastDate.toISOString().split('T')[0];
            } else {
                 nextStartDate = getMondayOfCurrentWeek().toISOString().split('T')[0];
            }
            
            workoutLog.push(getWeekObjectFromPlan(nextWeekNumber, nextStartDate));
            isInitialLoad = true;
            saveData(); 
        }

        function promptDeleteWeek(index) {
            weekIndexToDelete = index;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function executeDeleteWeek() {
            if (weekIndexToDelete !== null) {
                workoutLog.splice(weekIndexToDelete, 1);
                workoutLog.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                workoutLog.forEach((week, index) => { week.weekNumber = index + 1; });
                isInitialLoad = true;
                saveData();
                weekIndexToDelete = null;
            }
            document.getElementById('confirm-modal').style.display = 'none';
        }

        // --- GRAPHING ---
        function generateAndShowGraphs() {
            const otherContainer = document.getElementById('other-charts-container');
            const dailyVolumeContainer = document.getElementById('daily-volume-charts-container');
            const individualContainer = document.getElementById('individual-exercises-charts-container');
            const noGraphsMsg = document.getElementById('no-graphs-message');

            otherContainer.innerHTML = '';
            dailyVolumeContainer.innerHTML = '';
            individualContainer.innerHTML = '';
            noGraphsMsg.classList.add('hidden');
            
            const sortedLog = [...workoutLog].sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            let chartsPlotted = 0;

            // --- Body Weight Graph ---
            const bodyWeightData = [];
            sortedLog.forEach(week => {
                const meanWeightResult = calculateMeanWeight(week);
                const meanWeight = parseFloat(meanWeightResult.mean);

                if (!isNaN(meanWeight) && meanWeight > 0 && week.startDate) {
                    bodyWeightData.push({ x: new Date(week.startDate + 'T00:00:00'), y: meanWeight });
                }
            });
            
            if (bodyWeightData.length > 1) {
                chartsPlotted++;
                const bwChartWrapper = document.createElement('div');
                bwChartWrapper.className = 'p-4 rounded-lg bg-gray-50 dark:bg-gray-700';
                const bwTitle = document.createElement('h4');
                bwTitle.className = 'text-lg font-semibold mb-2 text-center text-gray-800 dark:text-gray-200';
                bwTitle.textContent = 'Mean Body Weight (kg)';
                const bwCanvas = document.createElement('canvas');
                bwChartWrapper.appendChild(bwTitle);
                bwChartWrapper.appendChild(bwCanvas);
                otherContainer.appendChild(bwChartWrapper);
                createChart(bwCanvas, 'Mean Body Weight (kg)', bodyWeightData, '#ef4444', 'rgba(239, 68, 68, 0.2)');
            }

            // --- Weekly Total Volume Graph ---
            const weeklyVolumeData = [];
            sortedLog.forEach(week => {
                const volume = calculateWeekVolume(week);
                if (volume > 0 && week.startDate) {
                    weeklyVolumeData.push({ x: new Date(week.startDate + 'T00:00:00'), y: volume });
                }
            });

            if (weeklyVolumeData.length > 1) {
                chartsPlotted++;
                const wvChartWrapper = document.createElement('div');
                wvChartWrapper.className = 'p-4 rounded-lg bg-gray-50 dark:bg-gray-700';
                const wvTitle = document.createElement('h4');
                wvTitle.className = 'text-lg font-semibold mb-2 text-center text-gray-800 dark:text-gray-200';
                wvTitle.textContent = 'Weekly Total Volume (kg)';
                const wvCanvas = document.createElement('canvas');
                wvChartWrapper.appendChild(wvTitle);
                wvChartWrapper.appendChild(wvCanvas);
                otherContainer.appendChild(wvChartWrapper);
                createChart(wvCanvas, 'Weekly Volume (kg)', weeklyVolumeData, '#10b981', 'rgba(16, 185, 129, 0.2)');
            }

            // --- Daily Volume Graphs ---
            const dailyVolumeData = {};
            sortedLog.forEach(week => {
                if (week.startDate && week.days) {
                    const weekDate = new Date(week.startDate + 'T00:00:00');
                    week.days.forEach(day => {
                        const dayVolume = calculateDayVolume(day);
                        if (dayVolume > 0) {
                            if (!dailyVolumeData[day.dayName]) dailyVolumeData[day.dayName] = [];
                            dailyVolumeData[day.dayName].push({ x: weekDate, y: dayVolume });
                        }
                    });
                }
            });

            for (const dayName in dailyVolumeData) {
                const data = dailyVolumeData[dayName];
                if (data.length > 1) {
                    chartsPlotted++;
                    const chartWrapper = document.createElement('div');
                    chartWrapper.className = 'p-4 rounded-lg bg-gray-50 dark:bg-gray-700';
                    const title = document.createElement('h4');
                    title.className = 'text-lg font-semibold mb-2 text-center text-gray-800 dark:text-gray-200';
                    title.textContent = `${dayName} - Total Volume`;
                    const canvas = document.createElement('canvas');
                    chartWrapper.appendChild(title);
                    chartWrapper.appendChild(canvas);
                    dailyVolumeContainer.appendChild(chartWrapper);
                    createChart(canvas, 'Total Volume (kg)', data, '#8b5cf6', 'rgba(139, 92, 246, 0.2)');
                }
            }

            // --- Individual Exercise Progress Graphs ---
            const individualChartData = {};
            sortedLog.forEach(week => {
                if (week.startDate && week.days) {
                    const weekDate = new Date(week.startDate + 'T00:00:00');
                    week.days.forEach(day => {
                        if(!day.exercises) return;
                        day.exercises.forEach(ex => {
                            const total = calculateTotal(ex);
                            if (total.value > 0) {
                                if (!individualChartData[ex.name]) individualChartData[ex.name] = { data: new Map(), unit: total.unit };
                                const existingValue = individualChartData[ex.name].data.get(weekDate.getTime()) || 0;
                                individualChartData[ex.name].data.set(weekDate.getTime(), existingValue + total.value);
                            }
                        });
                    });
                }
            });

            for (const exerciseName in individualChartData) {
                const dataMap = individualChartData[exerciseName].data;
                const chartData = Array.from(dataMap.entries()).map(([time, value]) => ({ x: new Date(time), y: value })).sort((a, b) => a.x - b.x);

                if(chartData.length > 1) {
                    chartsPlotted++;
                    const chartWrapper = document.createElement('div');
                    chartWrapper.className = 'p-4 rounded-lg bg-gray-50 dark:bg-gray-700';
                    const title = document.createElement('h4');
                    title.className = 'text-lg font-semibold mb-2 text-center text-gray-800 dark:text-gray-200';
                    title.textContent = exerciseName;
                    const canvas = document.createElement('canvas');
                    chartWrapper.appendChild(title);
                    chartWrapper.appendChild(canvas);
                    individualContainer.appendChild(chartWrapper);
                    const chartLabel = individualChartData[exerciseName].unit === 'reps' ? 'Total Reps' : 'Total Volume (kg)';
                    createChart(canvas, chartLabel, chartData, '#2dd4bf', 'rgba(45, 212, 191, 0.2)');
                }
            }

            if(chartsPlotted === 0) {
                noGraphsMsg.classList.remove('hidden');
            }
            
            const graphToggleButtons = document.querySelectorAll('.graph-toggle-btn');
            const graphCategoryContainers = document.querySelectorAll('[data-graph-category]');

            graphToggleButtons.forEach(b => b.classList.remove('active'));
            graphCategoryContainers.forEach(c => c.classList.add('hidden'));

            if (graphToggleButtons.length > 0) {
                graphToggleButtons[0].classList.add('active');
                const firstContainer = document.querySelector(`[data-graph-category="${graphToggleButtons[0].dataset.category}"]`);
                if(firstContainer) firstContainer.classList.remove('hidden');
            }

            document.getElementById('graph-modal').style.display = 'flex';
        }

        function createChart(canvas, label, chartData, mainColor, transparentColor) {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
            
            new Chart(canvas, {
                type: 'line',
                data: {
                    datasets: [{
                        label: label,
                        data: chartData,
                        fill: true,
                        backgroundColor: transparentColor,
                        borderColor: mainColor,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: mainColor,
                        pointHoverBackgroundColor: '#ffffff',
                        pointHoverBorderColor: mainColor,
                        pointBorderWidth: 1.5,
                        pointRadius: 4,
                        tension: 0.4
                    }]
                },
                options: { 
                     responsive: true,
                     maintainAspectRatio: true,
                     scales: { 
                         y: { 
                             beginAtZero: false, 
                             ticks: { color: labelColor, font: { weight: '500' } }, 
                             grid: { color: gridColor, drawBorder: false } 
                         }, 
                         x: { 
                             type: 'time',
                             time: {
                                 unit: 'week',
                                 tooltipFormat: 'dd/MM/yyyy',
                                 displayFormats: {
                                     week: 'dd/MM/yyyy'
                                 }
                             },
                             ticks: { color: labelColor, font: { weight: '500' } }, 
                             grid: { color: gridColor, drawBorder: false }
                         }
                    }, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: isDarkMode ? '#1f2937' : '#ffffff',
                            titleColor: isDarkMode ? '#f9fafb' : '#1f2937',
                            bodyColor: isDarkMode ? '#d1d5db' : '#4b5563',
                            borderColor: gridColor, borderWidth: 1, padding: 10, caretPadding: 10, displayColors: false,
                            callbacks: { 
                                title: (tooltipItems) => {
                                    const date = new Date(tooltipItems[0].parsed.x);
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const year = date.getFullYear();
                                    return `${day}/${month}/${year}`;
                                },
                                label: (context) => `${context.dataset.label}: ${context.parsed.y}` 
                            }
                        }
                    }
                }
            });
        }

        // --- UTILITIES ---
        function getMondayOfCurrentWeek() {
            const today = new Date();
            const day = today.getDay(); // Sunday - 0, Monday - 1, ...
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            return new Date(today.setDate(diff));
        }

        function formatDateToDDMMYYYY(isoDate) {
            if (!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return '';
            const [year, month, day] = isoDate.split('-');
            return `${day}/${month}/${year}`;
        }

        function parseDDMMYYYYtoYMD(dateStr) {
            if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return null;
            const [day, month, year] = dateStr.split('/');
            const date = new Date(`${year}-${month}-${day}T00:00:00`);
            if (date && date.getFullYear() == year && date.getMonth() + 1 == month && date.getDate() == day) {
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            return null;
        }

        // --- IMPORT/EXPORT ---
        function exportData() {
            if (workoutLog.length === 0) {
                showStatusMessage('No data to export.', 'info');
                return;
            }
            const jsonString = JSON.stringify(workoutLog, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const date = `${day}-${month}-${year}`;
            a.download = `workout-log-${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importDataFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedLog = JSON.parse(e.target.result);
                    if (Array.isArray(importedLog)) {
                        workoutLog = workoutLog.concat(importedLog);
                        workoutLog.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                        workoutLog.forEach((week, index) => { week.weekNumber = index + 1; });
                        
                        isInitialLoad = true;
                        saveData();
                        showStatusMessage('Data imported successfully! The log will refresh shortly.', 'success');
                    } else {
                        throw new Error('Invalid file structure. Expected an array of weeks.');
                    }
                } catch (error) {
                    console.error('Failed to import data:', error);
                    showStatusMessage(`Error: Invalid file. ${error.message}`, 'error');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        // --- UI UTILITIES ---
        function showStatusMessage(message, type = 'loading') {
            const indicator = document.getElementById('status-indicator');
            let icon = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            if (type === 'success') indicator.className = 'mt-4 flex items-center text-green-500';
            else if (type === 'error') indicator.className = 'mt-4 flex items-center text-red-500';
            else indicator.className = 'mt-4 flex items-center text-blue-500';
            
            indicator.innerHTML = `${icon}<span>${message}</span>`;
            indicator.style.display = 'flex';
        }

        function hideStatusMessage() {
            const indicator = document.getElementById('status-indicator');
            indicator.style.display = 'none';
        }

        // --- DATA PERSISTENCE ---
        let saveTimeout;
        function saveData() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (!userId || !db) return;
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'workoutData', 'mainLog');
                try {
                    await setDoc(docRef, { log: workoutLog });
                    console.log('Workout log saved.');
                } catch (error) {
                    console.error("Error saving data:", error);
                    showStatusMessage('Error saving data automatically.', 'error');
                }
            }, 300);
        }
        
        // --- START THE APP ---
        init();
    </script>
</body>
</html>
